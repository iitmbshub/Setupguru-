<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SETUP GURU SUPPORT - Live Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .dark body { 
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #e0e0e0; 
        }
        
        .chat-container {
            height: calc(100vh - 140px);
            overflow-y: auto;
            scroll-behavior: smooth;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0;
        }
        
        .dark .chat-container {
            background: rgba(26, 32, 44, 0.95);
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            margin-bottom: 12px;
            font-size: 0.95rem;
            line-height: 1.4;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            word-wrap: break-word;
            position: relative;
        }
        
        .user-message { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            align-self: flex-end; 
            border-bottom-right-radius: 6px;
            margin-left: auto;
        }
        
        .admin-message { 
            background: #ffffff;
            color: #2d3748;
            align-self: flex-start; 
            border-bottom-left-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .dark .admin-message { 
            background: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }
        
        .status-icon { font-size: 0.7rem; margin-left: 6px; }
        .time-stamp { 
            display: block; 
            font-size: 0.75rem; 
            margin-top: 4px; 
            text-align: right;
            opacity: 0.8;
        }
        
        .user-time-stamp { color: rgba(255,255,255,0.9); }
        .admin-time-stamp { color: #718096; }
        .dark .admin-time-stamp { color: #a0aec0; }
        
        .typing-indicator span { 
            display: inline-block; 
            width: 8px; 
            height: 8px; 
            margin: 0 2px; 
            border-radius: 50%; 
            background-color: #667eea; 
            animation: typing-animation 1.4s infinite ease-in-out;
        }
        
        .dark .typing-indicator span { background-color: #a0aec0; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing-animation {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            transition: left 0.3s ease;
            z-index: 50;
            border-right: 1px solid #e2e8f0;
        }
        
        .dark .sidebar {
            background: rgba(26, 32, 44, 0.98);
            border-right-color: #4a5568;
        }
        
        .sidebar.open { left: 0; }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .chat-history-item {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .chat-history-item:hover {
            background-color: #f7fafc;
        }
        
        .dark .chat-history-item {
            border-bottom-color: #4a5568;
        }
        
        .dark .chat-history-item:hover {
            background-color: #2d3748;
        }
        
        @media (max-width: 640px) {
            .message-bubble {
                max-width: 90%;
                padding: 10px 14px;
                font-size: 0.9rem;
            }
            
            .chat-container {
                padding: 0.75rem;
                height: calc(100vh - 130px);
            }
            
            .sidebar {
                width: 280px;
            }
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    
    <!-- Sidebar Overlay -->
    <div id="overlay" class="overlay"></div>
    
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
        <div class="p-4 border-b border-gray-200 dark:border-gray-600">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Chat History</h2>
                <button id="close-sidebar" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="p-4">
            <button id="new-chat-btn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-4 rounded-lg font-medium hover:from-blue-600 hover:to-purple-700 transition duration-200 mb-4">
                ✨ Start New Chat
            </button>
        </div>
        
        <div id="chat-history" class="flex-1 overflow-y-auto">
            <!-- Chat history items will be populated here -->
        </div>
    </div>

    <!-- Header Section -->
    <header class="flex justify-between items-center p-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur-md shadow-lg sticky top-0 z-30">
        <div class="flex items-center space-x-3">
            <button id="menu-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition lg:hidden">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <img src="https://i.ibb.co/CpZpc289/logoo.jpg" alt="Logo" class="w-10 h-10 rounded-full shadow-lg">
            <div>
                <h1 class="text-lg font-bold text-gray-800 dark:text-gray-100 hidden sm:block">SETUP GURU SUPPORT</h1>
                <h1 class="text-lg font-bold text-gray-800 dark:text-gray-100 sm:hidden">GURU SUPPORT</h1>
                <p class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">Professional Support Chat</p>
            </div>
        </div>

        <div class="flex items-center space-x-2">
            <button id="new-chat-header" class="hidden sm:flex items-center px-3 py-2 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-full text-sm font-medium hover:from-green-600 hover:to-blue-600 transition duration-200">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-1">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Chat
            </button>
            <button id="theme-toggle" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Chat Area -->
    <main class="flex-grow overflow-hidden flex flex-col relative">
        <div id="chat-container" class="chat-container flex flex-col space-y-3 flex-grow">
            <!-- Welcome message -->
            <div class="text-center py-8">
                <div class="inline-block p-6 bg-white/80 dark:bg-gray-800/80 rounded-2xl shadow-lg backdrop-blur-sm max-w-md mx-auto">
                    <img src="https://i.ibb.co/CpZpc289/logoo.jpg" alt="Support" class="w-16 h-16 rounded-full mx-auto mb-4 shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-3">Welcome to Setup Guru Support! 👋</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">We're here to help you with all your technical needs. Start a conversation and our support team will assist you shortly.</p>
                    <div class="flex items-center justify-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span>Online Support Available</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Typing Indicator -->
        <div id="typing-indicator" class="px-4 py-2 text-sm text-gray-500 dark:text-gray-400" style="display: none;">
            <div class="flex items-center bg-white/80 dark:bg-gray-800/80 rounded-full px-4 py-2 backdrop-blur-sm inline-block">
                <img src="https://i.ibb.co/CpZpc289/logoo.jpg" alt="Admin" class="w-6 h-6 rounded-full mr-3">
                <p class="mr-3 font-medium">Support team is typing</p>
                <div class="typing-indicator"><span></span><span></span><span></span></div>
            </div>
        </div>
    </main>

    <!-- Input Section -->
    <footer class="p-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border-t border-gray-200/50 dark:border-gray-700/50 sticky bottom-0 z-30">
        <div class="flex items-center space-x-3 max-w-4xl mx-auto">
            <!-- Attachment Button -->
            <label for="file-upload" class="bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-600 dark:to-gray-700 text-gray-600 dark:text-gray-200 p-3 rounded-full hover:from-gray-200 hover:to-gray-300 dark:hover:from-gray-500 dark:hover:to-gray-600 transition duration-200 cursor-pointer w-12 h-12 flex items-center justify-center shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                </svg>
            </label>
            <input type="file" id="file-upload" accept="image/*, application/pdf, .doc, .docx, .txt" class="hidden">
            
            <div class="flex-grow relative">
                <input type="text" id="message-input" placeholder="Type your message..." class="w-full p-4 pr-12 border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 shadow-lg bg-white/80 dark:bg-gray-700/80 backdrop-blur-sm">
            </div>
            
            <button id="send-button" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-3 rounded-full hover:from-blue-600 hover:to-purple-700 transition duration-200 flex items-center justify-center shadow-lg w-12 h-12 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </footer>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref as dbRef, push, onValue, serverTimestamp, set, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // --- Configuration and Constants ---
        const USER_ID_KEY = 'setup_guru_chat_user_id';
        const TELEGRAM_BOT_TOKEN = '8311976506:AAHCMdrwWzHbKYPVxItoiRXFg0hvppS_26c';
        const TELEGRAM_CHAT_IDS = ['5165964724', '5765135287'];
        const ADMIN_PANEL_LINK = 'admin-support.html';
        const SUPPORT_PHONE = '9499473347';
        const USER_AVATAR = 'https://iili.io/K0epkp2.md.jpg';
        const ADMIN_AVATAR = 'https://i.ibb.co/CpZpc289/logoo.jpg';

        // Provided Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDKAu9JvYmpQNfH1ES_Ax3q6qUFZX061Rw",
            authDomain: "raosuplode.firebaseapp.com",
            databaseURL: "https://raosuplode-default-rtdb.firebaseio.com",
            projectId: "raosuplode",
            storageBucket: "raosuplode.firebasestorage.app",
            messagingSenderId: "275156697009",
            appId: "1:275156697009:web:988cc8dc82f59e0535c790"
        };
        
        // --- Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // Get or generate a unique User ID
        let userId = localStorage.getItem(USER_ID_KEY);
        let isNewChat = false;
        let chatHistory = JSON.parse(localStorage.getItem('chat_history') || '[]');
        
        if (!userId) {
            userId = crypto.randomUUID();
            localStorage.setItem(USER_ID_KEY, userId);
            isNewChat = true;
            localStorage.setItem('user_agent', navigator.userAgent);
        }

        const chatRef = dbRef(db, 'chats/' + userId + '/messages');
        const typingRef = dbRef(db, 'typing/' + userId + '/admin');
        const seenRef = dbRef(db, 'chats/' + userId + '/seen/user');

        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const fileUpload = document.getElementById('file-upload');
        const typingIndicator = document.getElementById('typing-indicator');
        const themeToggle = document.getElementById('theme-toggle');
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const closeSidebar = document.getElementById('close-sidebar');
        const newChatBtn = document.getElementById('new-chat-btn');
        const newChatHeader = document.getElementById('new-chat-header');
        const chatHistoryContainer = document.getElementById('chat-history');
        
        // --- Utility Functions ---

        const formatTime = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        };
        
        const scrollToBottom = () => {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        };
        
        const updateMessageStatus = (messageKey, status) => {
             const statusUpdateRef = dbRef(db, `chats/${userId}/messages/${messageKey}/status`);
             set(statusUpdateRef, status);
        };

        const updateMessagesAsSeen = () => {
            set(seenRef, serverTimestamp());
        };
        
        const getStatusIcon = (status) => {
            switch (status) {
                case 'seen':
                    return '<span class="text-blue-500">👁️</span>';
                case 'delivered':
                    return '<span class="text-gray-400">✅✅</span>';
                case 'sent':
                default:
                    return '<span class="text-gray-400">✅</span>';
            }
        };
        
        // Chat History Functions
        const saveChatToHistory = (chatId, firstMessage) => {
            const existingIndex = chatHistory.findIndex(chat => chat.id === chatId);
            const chatData = {
                id: chatId,
                firstMessage: firstMessage.substring(0, 50) + (firstMessage.length > 50 ? '...' : ''),
                timestamp: Date.now(),
                lastActivity: Date.now()
            };
            
            if (existingIndex >= 0) {
                chatHistory[existingIndex] = chatData;
            } else {
                chatHistory.unshift(chatData);
            }
            
            if (chatHistory.length > 20) {
                chatHistory = chatHistory.slice(0, 20);
            }
            
            localStorage.setItem('chat_history', JSON.stringify(chatHistory));
            renderChatHistory();
        };
        
        const renderChatHistory = () => {
            chatHistoryContainer.innerHTML = '';
            
            if (chatHistory.length === 0) {
                chatHistoryContainer.innerHTML = `
                    <div class="p-4 text-center text-gray-500 dark:text-gray-400">
                        <p class="text-sm">No chat history yet</p>
                        <p class="text-xs mt-1">Start a conversation to see your chats here</p>
                    </div>
                `;
                return;
            }
            
            chatHistory.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-history-item ${chat.id === userId ? 'bg-blue-50 dark:bg-blue-900/20' : ''}`;
                chatItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                                ${chat.firstMessage}
                            </p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                ${new Date(chat.timestamp).toLocaleDateString()}
                            </p>
                        </div>
                        ${chat.id === userId ? '<div class="ml-2 w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                    </div>
                `;
                
                chatItem.addEventListener('click', () => {
                    if (chat.id !== userId) {
                        loadChat(chat.id);
                    }
                    closeSidebarFunc();
                });
                
                chatHistoryContainer.appendChild(chatItem);
            });
        };
        
        const loadChat = (chatId) => {
            userId = chatId;
            localStorage.setItem(USER_ID_KEY, userId);
            location.reload();
        };
        
        const startNewChat = () => {
            const newUserId = crypto.randomUUID();
            localStorage.setItem(USER_ID_KEY, newUserId);
            location.reload();
        };
        
        // Sidebar Functions
        const openSidebar = () => {
            sidebar.classList.add('open');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        };
        
        const closeSidebarFunc = () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        };

        // --- Link/Media Preview Implementation ---
        const URL_REGEX = /(https?:\/\/[^\s]+)/g;
        const YOUTUBE_REGEX = /(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S*)/;
        const IMAGE_REGEX = /\.(jpeg|jpg|png|gif|webp)(\?.*)?$/i;

        const renderUrlContent = (url, isUser) => {
            let contentHtml = '';
            const bubbleBg = isUser ? 'bg-green-500' : 'bg-blue-500';
            const buttonText = 'Open Link';
            
            const youtubeMatch = url.match(YOUTUBE_REGEX);
            if (youtubeMatch) {
                const videoId = youtubeMatch[1];
                const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                contentHtml = `
                    <div class="relative w-full h-auto rounded-lg overflow-hidden cursor-pointer" onclick="window.open('${url}', '_blank')">
                        <img src="${thumbnailUrl}" alt="YouTube Video Thumbnail" class="w-full object-cover">
                        <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30">
                            <svg class="w-10 h-10 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l3.37 1.95c.16.09.35.14.53.14s.37-.05.53-.14l3.37-1.95c.34-.2.53-.57.53-.94V8.45c0-.75-.68-1.21-1.39-.81L12 10.59l-4.41-2.95c-.71-.4-1.39.06-1.39.81v3.49c0 .37.19.74.53.94z"/></svg>
                        </div>
                    </div>
                `;
            } else if (url.match(IMAGE_REGEX)) {
                contentHtml = `
                    <a href="${url}" target="_blank" class="block w-full h-auto overflow-hidden rounded-lg">
                        <img src="${url}" alt="Image Preview" class="w-full object-cover rounded-lg max-h-48" onerror="this.onerror=null; this.parentNode.innerHTML='<div class=\\"p-2 text-sm text-center text-gray-500\\">Image failed to load.</div>'">
                    </a>
                `;
            } else {
                contentHtml = `
                    <div class="p-2 border border-gray-200 dark:border-gray-600 rounded-lg my-1 bg-white dark:bg-gray-700 w-full">
                        <p class="text-xs font-semibold text-blue-600 dark:text-blue-400 truncate">${new URL(url).hostname}</p>
                        <p class="text-sm font-medium dark:text-gray-100 mt-1 mb-2">Website Preview</p>
                        <a href="${url}" target="_blank" class="inline-block px-3 py-1 text-xs text-white ${bubbleBg} rounded-full hover:opacity-90 transition duration-150">${buttonText}</a>
                    </div>
                `;
            }
            return contentHtml;
        };

        const createMessageElement = (message) => {
            const isUser = message.sender === 'user';
            const avatarUrl = isUser ? USER_AVATAR : ADMIN_AVATAR;
            const bubbleClass = isUser ? 'user-message' : 'admin-message';
            const timeClass = isUser ? 'user-time-stamp' : 'admin-time-stamp';

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-end max-w-full ${isUser ? 'justify-end' : 'justify-start'} mb-4`;

            const avatar = document.createElement('img');
            avatar.src = avatarUrl;
            avatar.alt = message.sender;
            avatar.className = 'w-8 h-8 rounded-full shadow-md';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `message-bubble ${bubbleClass} ${message.is_deleted ? 'italic opacity-60' : ''}`;
            
            if (isUser) {
                messageWrapper.appendChild(contentDiv);
                messageWrapper.appendChild(avatar);
                contentDiv.style.marginRight = '8px';
            } else {
                messageWrapper.appendChild(avatar);
                messageWrapper.appendChild(contentDiv);
                contentDiv.style.marginLeft = '8px';
            }
            
            if (message.is_deleted) {
                 contentDiv.textContent = "This message was deleted.";
            } else if (message.fileUrl) {
                const fileName = message.fileName || 'File Attachment';
                contentDiv.innerHTML = `<p class="font-bold text-sm mb-1">${isUser ? 'You sent' : 'Admin sent'} an attachment:</p>`;
                
                if (message.fileType.startsWith('image/')) {
                    contentDiv.innerHTML += `<a href="${message.fileUrl}" target="_blank"><img src="${message.fileUrl}" alt="${fileName}" class="max-h-40 w-auto rounded-lg my-2 object-cover"></a>`;
                } else if (message.fileType === 'application/pdf') {
                    contentDiv.innerHTML += `
                        <p class="text-sm my-2 truncate">${fileName}</p>
                        <a href="${message.fileUrl}" target="_blank" class="px-3 py-1 bg-red-600 text-white rounded-full text-xs hover:bg-red-700 transition duration-150 self-start mt-1">
                            ⬇️ Download PDF
                        </a>
                    `;
                } else {
                     contentDiv.innerHTML += `<p class="text-sm my-2 truncate">${fileName}</p><a href="${message.fileUrl}" target="_blank" class="px-3 py-1 bg-gray-600 text-white rounded-full text-xs hover:bg-gray-700 transition duration-150 self-start mt-1">Download File</a>`;
                }
            } else {
                let text = message.text;
                let renderedContent = '';
                let lastIndex = 0;
                let match;

                while ((match = URL_REGEX.exec(text)) !== null) {
                    renderedContent += text.substring(lastIndex, match.index);
                    const url = match[0];
                    renderedContent += renderUrlContent(url, isUser);
                    lastIndex = match.index + url.length;
                }
                renderedContent += text.substring(lastIndex);
                
                contentDiv.innerHTML = renderedContent;
            }
            
            const statusIcon = isUser ? getStatusIcon(message.status) : '';
            const timeSpan = document.createElement('span');
            timeSpan.className = `time-stamp flex items-center justify-end ${timeClass}`;
            timeSpan.innerHTML = `${formatTime(message.timestamp)} ${statusIcon}`;
            contentDiv.appendChild(timeSpan);
            
            return messageWrapper;
        };

        // --- File Upload Logic ---
        const uploadFile = async (file) => {
            if (!file) return;

            const fileExtension = file.name.split('.').pop();
            const filePath = `chats/${userId}/${crypto.randomUUID()}.${fileExtension}`;
            const fileRef = storageRef(storage, filePath);
            const uploadTask = uploadBytesResumable(fileRef, file);

            const placeholderMsg = {
                sender: 'user',
                text: `Uploading ${file.name} (${(file.size / 1024).toFixed(2)} KB)...`,
                timestamp: Date.now(),
                isPlaceholder: true
            };
            
            const placeholderEl = createMessageElement(placeholderMsg);
            chatContainer.appendChild(placeholderEl);
            scrollToBottom();

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    placeholderEl.querySelector('.message-bubble').textContent = `Uploading ${file.name}: ${progress.toFixed(0)}%...`;
                }, 
                (error) => {
                    console.error("Upload failed:", error);
                    placeholderEl.querySelector('.message-bubble').textContent = `Upload Failed: ${error.message}`;
                }, 
                async () => {
                    const fileUrl = await getDownloadURL(uploadTask.snapshot.ref);
                    
                    const messageData = {
                        sender: 'user',
                        text: file.name,
                        fileUrl: fileUrl,
                        fileName: file.name,
                        fileType: file.type,
                        timestamp: serverTimestamp(),
                        userId: userId,
                        status: 'sent'
                    };
                    
                    const newUserMsgRef = await push(chatRef, messageData);
                    
                    if (isNewChat) {
                         sendAdminAutoReply(newUserMsgRef.key, file.name);
                    } else {
                        // Send notification for file uploads too
                        const adminPanelUrl = `${window.location.origin}/support-admin.html?userId=${userId}`;
                        const telegramMessage = `📎 *File uploaded by User:* \`${userId}\`\n\n📁 *File:* ${file.name}\n📏 *Size:* ${(file.size / 1024).toFixed(2)} KB\n⏰ *Time:* ${new Date().toLocaleString()}\n\n🔗 [Click to respond](${adminPanelUrl})`;
                        sendTelegramNotification(telegramMessage);
                    }
                    
                    placeholderEl.remove();
                }
            );
        };
        
        fileUpload.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                uploadFile(e.target.files[0]);
                e.target.value = '';
            }
        });
        
        // --- Chat Logic ---
        const sendTelegramNotification = async (message) => {
            const apiEndpoint = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            
            for (const chatId of TELEGRAM_CHAT_IDS) {
                const payload = { 
                    chat_id: chatId, 
                    text: message, 
                    parse_mode: 'Markdown',
                    disable_web_page_preview: false
                };
                try {
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        console.error(`Telegram API error for ${chatId}:`, await response.text());
                    }
                } catch (error) {
                    console.error(`Telegram fetch failed for ${chatId}:`, error);
                }
            }
        };

        const sendAdminAutoReply = async (userMessageKey, firstMessageText) => {
            // Send multiple auto-reply messages to collect user information
            const autoReplyMessages = [
                "Hello 👋 Welcome to Setup Guru Support! I'm here to help you.",
                "To provide you with the best assistance, I need some information:",
                "1️⃣ What's your name?",
                "2️⃣ Have you logged into our system? (Yes/No)",
                "3️⃣ Please describe your problem in detail so our support team can assist you better.",
                "Our support team will respond shortly. Thank you for your patience! 😊"
            ];
            
            // Send each auto-reply message with a small delay
            for (let i = 0; i < autoReplyMessages.length; i++) {
                setTimeout(async () => {
                    await push(chatRef, {
                        sender: 'admin',
                        text: autoReplyMessages[i],
                        timestamp: serverTimestamp(),
                        is_auto_reply: true,
                        triggered_by: userMessageKey
                    });
                }, i * 1000); // 1 second delay between messages
            }
            
            // Store chat info
            const firstMsgRef = dbRef(db, 'chats/' + userId + '/info');
            set(firstMsgRef, {
                firstMessage: firstMessageText,
                timestamp: Date.now(),
                userAgent: localStorage.getItem('user_agent') || 'Unknown Device',
                status: 'new'
            });

            // Send enhanced Telegram notification
            const adminPanelUrl = `${window.location.origin}/support-admin.html?userId=${userId}`;
            const telegramMessage = `🆆 *NEW SUPPORT CHAT STARTED*\n\n👤 *User ID:* \`${userId}\`\n📝 *First Message:* "${firstMessageText}"\n📱 *Device:* ${navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop'}\n⏰ *Time:* ${new Date().toLocaleString()}\n\n🔗 [Click to respond immediately](${adminPanelUrl})\n\n⚡ *Quick Actions:*\n- Reply to user\n- View chat history\n- Manage support tickets`;
            
            sendTelegramNotification(telegramMessage);
            
            isNewChat = false; 
        };

        const sendMessage = async () => {
            const text = messageInput.value.trim();
            if (text === '') return;

            const firstMessageText = text; // Store before clearing
            messageInput.value = '';
            messageInput.focus();
            
            try {
                const newUserMsgRef = await push(chatRef, {
                    sender: 'user',
                    text: text,
                    timestamp: serverTimestamp(),
                    userId: userId,
                    status: 'sent'
                });
                
                if (isNewChat) {
                    await sendAdminAutoReply(newUserMsgRef.key, firstMessageText);
                } else {
                    // Send notification for existing chat messages too
                    const adminPanelUrl = `${window.location.origin}/support-admin.html?userId=${userId}`;
                    const telegramMessage = `💬 *New message from User:* \`${userId}\`\n\n📝 *Message:* "${text}"\n⏰ *Time:* ${new Date().toLocaleString()}\n\n🔗 [Click to respond](${adminPanelUrl})`;
                    sendTelegramNotification(telegramMessage);
                }

            } catch (error) {
                console.error("Error sending message:", error);
            }
        };

        // --- Event Listeners ---
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        let typingTimeout;
        const setTypingStatus = (isTyping) => {
            const typingStatusRef = dbRef(db, 'typing/' + userId + '/user');
            set(typingStatusRef, isTyping ? Date.now() : false);
        };

        messageInput.addEventListener('input', () => {
            clearTimeout(typingTimeout);
            setTypingStatus(true);
            typingTimeout = setTimeout(() => {
                setTypingStatus(false);
            }, 3000); 
        });

        // --- Real-time Listeners (onValue) ---
        onValue(chatRef, (snapshot) => {
            const messages = snapshot.val();
            
            if (messages) {
                const welcomeMsg = chatContainer.querySelector('.text-center');
                if (welcomeMsg) welcomeMsg.remove();
            }
            
            chatContainer.innerHTML = '';
            
            if (messages) {
                const messageList = Object.keys(messages).map(key => ({
                    ...messages[key],
                    key,
                    timestamp: messages[key].timestamp || Date.now() 
                }));

                messageList.sort((a, b) => a.timestamp - b.timestamp);
                let lastAdminMessageKey = null;
                let firstUserMessage = null;

                messageList.forEach(message => {
                    const el = createMessageElement(message);
                    chatContainer.appendChild(el);
                    
                    if (message.sender === 'user' && !firstUserMessage) {
                        firstUserMessage = message.text || 'File attachment';
                    }
                    
                    if (message.sender === 'admin' && message.key) {
                        lastAdminMessageKey = message.key;
                        if (message.status === 'sent') {
                            updateMessageStatus(message.key, 'delivered');
                        }
                    }
                });
                
                if (firstUserMessage) {
                    saveChatToHistory(userId, firstUserMessage);
                }
                
                updateMessagesAsSeen();
            } else {
                chatContainer.innerHTML = `
                    <div class="text-center py-8">
                        <div class="inline-block p-6 bg-white/80 dark:bg-gray-800/80 rounded-2xl shadow-lg backdrop-blur-sm max-w-md mx-auto">
                            <img src="https://i.ibb.co/CpZpc289/logoo.jpg" alt="Support" class="w-16 h-16 rounded-full mx-auto mb-4 shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-3">Welcome to Setup Guru Support! 👋</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">We're here to help you with all your technical needs. Start a conversation and our support team will assist you shortly.</p>
                            <div class="flex items-center justify-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span>Online Support Available</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            scrollToBottom();
        });
        
        onValue(typingRef, (snapshot) => {
            const adminTypingTime = snapshot.val();
            const isTyping = adminTypingTime && (Date.now() - adminTypingTime) < 3000;
            typingIndicator.style.display = isTyping ? 'block' : 'none';
            if (isTyping) {
                scrollToBottom();
            }
        });
        
        // --- Dark Mode Logic ---
        const initializeTheme = () => {
            const isDark = localStorage.getItem('theme') === 'dark' || 
                           (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
            document.body.classList.toggle('dark', isDark);
        };
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Event Listeners for new features
        menuToggle.addEventListener('click', openSidebar);
        closeSidebar.addEventListener('click', closeSidebarFunc);
        overlay.addEventListener('click', closeSidebarFunc);
        newChatBtn.addEventListener('click', startNewChat);
        newChatHeader.addEventListener('click', startNewChat);
        
        // Initialize
        window.onload = () => {
            initializeTheme();
            renderChatHistory();
        };
        
        // Handle escape key to close sidebar
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                closeSidebarFunc();
            }
        });
    </script>
</body>
</html>