<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - SetupGuru</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2E1A5F; --secondary-color: #C49B46; --background-color: #f4f7fc;
            --text-color: #212529; --card-bg: #ffffff; --shadow-color: rgba(46, 26, 95, 0.1);
            --border-color: #e9ecef; --success-color: #2ecc71; --error-color: #e74c3c;
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--background-color); font-family: 'Poppins', sans-serif; color: var(--text-color); }
        
        /* --- HEADER --- */
        .header {
            background: var(--card-bg); padding: 1rem 1.5rem; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 2px 10px var(--shadow-color); position: sticky; top: 0; z-index: 1000;
        }
        .back-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-color); cursor: pointer; }
        .logo-text { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); text-decoration: none; position: absolute; left: 50%; transform: translateX(-50%); }
        .user-info { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        #user-name { font-weight: 600; color: var(--primary-color); }
        .profile-avatar {
            width: 45px; height: 45px; border-radius: 50%;
            background-image: url('https://i.ibb.co/zT8W3ZhL/pngtree-user-profile-avatar-png-image-10211467.png');
            background-size: cover; background-position: center; border: 2px solid var(--secondary-color);
        }

        /* --- LOADER --- */
        #loader-container { display: flex; justify-content: center; align-items: center; padding: 5rem 0; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- MAIN LAYOUT --- */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .cart-layout { display: grid; grid-template-columns: 2.5fr 1fr; gap: 2rem; align-items: start; }
        .cart-items, .order-summary { background: var(--card-bg); padding: 1.5rem 2rem; border-radius: 12px; box-shadow: 0 5px 15px var(--shadow-color); }
        .cart-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        h1, h2 { color: var(--primary-color); }
        .clear-cart-btn { background: none; border: 1px solid var(--error-color); color: var(--error-color); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
        .clear-cart-btn:hover { background-color: var(--error-color); color: white; }

        /* --- CART ITEM STYLES --- */
        .cart-item { display: grid; grid-template-columns: 100px 1fr auto; gap: 1.5rem; align-items: center; padding: 1.5rem 0; border-bottom: 1px solid var(--border-color); transition: opacity 0.3s; }
        .cart-item:last-child { border-bottom: none; }
        .item-img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; }
        .item-details h3 { font-size: 1.1rem; margin: 0 0 5px; }
        .item-price-details .current-price { font-size: 1.2rem; font-weight: 600; }
        .item-price-details .original-price { font-size: 0.9rem; text-decoration: line-through; color: #888; margin-left: 8px; }
        .stock-message { font-size: 0.85rem; font-weight: 600; color: var(--error-color); margin-top: 8px; }

        .item-actions { text-align: right; }
        .quantity-control { display: flex; align-items: center; border: 1px solid var(--border-color); border-radius: 20px; margin-bottom: 10px; }
        .quantity-control button { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px 12px; color: var(--text-color); }
        .quantity-control button:disabled { color: #ccc; cursor: not-allowed; }
        .quantity-control input { width: 40px; text-align: center; border: none; font-size: 1rem; background: transparent; }
        .remove-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 0.9rem; transition: color 0.2s; }
        .remove-btn:hover { color: var(--error-color); }

        /* --- ORDER SUMMARY --- */
        .order-summary { position: sticky; top: 100px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 1.1rem; }
        .summary-row.total { font-weight: 700; font-size: 1.3rem; border-top: 2px solid var(--border-color); padding-top: 1rem; }
        .checkout-btn { width: 100%; padding: 1rem; border: none; background: var(--secondary-color); color: var(--primary-color); font-size: 1.2rem; font-weight: 700; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .checkout-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(196, 155, 70, 0.3); }
        .checkout-btn:disabled { background-color: #ccc; color: #666; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* --- EMPTY CART / MESSAGE CONTAINER --- */
        .message-container { text-align: center; padding: 4rem; background: var(--card-bg); border-radius: 12px; }
        .message-container svg { width: 100px; margin-bottom: 1.5rem; color: var(--primary-color); }
        .message-container h2 { margin-bottom: 0.5rem; }
        .message-container p { color: #666; margin-bottom: 1.5rem; }
        .message-container a { text-decoration: none; padding: 12px 25px; background: var(--primary-color); color: white; border-radius: 8px; font-weight: 600; }
        
        /* --- TOAST NOTIFICATION --- */
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 1rem 2rem; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: bottom 0.5s ease-in-out; z-index: 2000; }
        .toast.show { bottom: 30px; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--error-color); }

        /* --- CONFIRMATION MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 3000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; text-align: center; width: 90%; max-width: 400px; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 1rem; color: var(--primary-color); }
        .modal-content p { margin-bottom: 2rem; color: #555; }
        .modal-buttons { display: flex; gap: 1rem; justify-content: center; }
        .modal-btn { padding: 10px 25px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; }
        .modal-btn.confirm { background-color: var(--error-color); color: white; }
        .modal-btn.cancel { background-color: #eee; color: var(--text-color); }
        
        /* --- RESPONSIVE --- */
        @media (max-width: 900px) { .cart-layout { grid-template-columns: 1fr; } .order-summary { position: static; } }
        @media (max-width: 500px) { .logo-text { display: none; } }
    </style>
</head>
<body>
    <header class="header">
        <button class="back-btn" onclick="window.history.back()"><i class="fas fa-arrow-left"></i></button>
        <a href="index.html" class="logo-text">SetupGuru</a>
        <a href="profile.html" class="user-info">
            <span id="user-name"></span>
            <div class="profile-avatar"></div>
        </a>
    </header>

    <div class="container" id="container">
        <div id="loader-container"><div class="spinner"></div></div>
        <div id="main-content" style="display: none;">
            <div class="cart-layout" id="cart-content">
                <div class="cart-items">
                    <div class="cart-header">
                        <h1>Your Shopping Cart</h1>
                        <button class="clear-cart-btn" id="clearCartBtn"><i class="fas fa-trash"></i> Clear Cart</button>
                    </div>
                    <div id="cart-items-container"></div>
                </div>
                <div class="order-summary">
                    <h2>Order Summary</h2>
                    <div class="summary-row"><span>Subtotal</span><span id="subtotal-price">₹0</span></div>
                    <div class="summary-row"><span>Delivery Fee</span><span id="delivery-fee">₹19</span></div>
                    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1rem 0;">
                    <div class="summary-row total"><span>Total</span><span id="total-price">₹0</span></div>
                    <button class="checkout-btn" id="checkoutBtn">Proceed to Checkout</button>
                </div>
            </div>
            <div id="empty-cart-message" style="display: none;">
                 <div class="message-container">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 9H13V6H11V9ZM12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 17H13V11H11V17Z"/></svg>
                    <h2>Your Cart is Currently Empty</h2>
                    <p>Looks like you haven't added anything to your cart yet. Let's find something for your setup!</p>
                    <a href="items.html">Start Shopping</a>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">Are you sure?</h3>
            <p id="modal-message">This action cannot be undone.</p>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="modal-btn cancel">Cancel</button>
                <button id="modal-confirm-btn" class="modal-btn confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAMweRCGXZCfuRvtlVO0acLbKmY4heV08s", authDomain: "setupguru-217af.firebaseapp.com", projectId: "setupguru-217af", storageBucket: "setupguru-217af.firebasestorage.app", messagingSenderId: "377386830551", appId: "1:377386830551:web:39909b0addf2bc630be92" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let cartItemsData = [];

        // DOM Elements
        const loader = document.getElementById('loader-container');
        const mainContent = document.getElementById('main-content');
        const emptyCartMsg = document.getElementById('empty-cart-message');
        const cartContent = document.getElementById('cart-content');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const userNameDisplay = document.getElementById('user-name');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const clearCartBtn = document.getElementById('clearCartBtn');

        // --- AUTHENTICATION ---
        auth.onAuthStateChanged(user => {
            if (user) {
                loadCartItems(user.uid);
                loadUserProfile(user);
            } else {
                loader.innerHTML = `
                <div class="message-container">
                    <h2>Login Required</h2><p>Please log in to see your cart.</p><a href="login.html">Login Now</a>
                </div>`;
            }
        });

        // --- DATA LOADING ---
        async function loadUserProfile(user) {
            const userDoc = await db.collection('users').doc(user.uid).get();
            userNameDisplay.textContent = userDoc.exists() ? (userDoc.data().fullName || user.email) : user.email;
        }

        async function loadCartItems(uid) {
            try {
                const cartSnapshot = await db.collection('users').doc(uid).collection('cart').get();
                if (cartSnapshot.empty) { showEmptyCart(); return; }

                const itemPromises = cartSnapshot.docs.map(cartDoc => 
                    db.collection('items').doc(cartDoc.data().itemId).get().then(itemDoc => 
                        itemDoc.exists ? { id: itemDoc.id, ...itemDoc.data(), quantity: cartDoc.data().quantity } : null
                    )
                );
                cartItemsData = (await Promise.all(itemPromises)).filter(Boolean);
                
                if (cartItemsData.length > 0) {
                    renderCart();
                    loader.style.display = 'none';
                    mainContent.style.display = 'block';
                } else { showEmptyCart(); }
            } catch (error) {
                console.error("Error loading cart:", error);
                loader.innerHTML = `<div class="message-container"><h2>Oops!</h2><p>Could not load your cart. Please refresh the page.</p></div>`;
            }
        }

        // --- UI RENDERING ---
        function showEmptyCart() {
            loader.style.display = 'none';
            mainContent.style.display = 'block';
            cartContent.style.display = 'none';
            emptyCartMsg.style.display = 'block';
        }

        function renderCart() {
            cartItemsContainer.innerHTML = cartItemsData.map(item => {
                const discountPercent = item.discountPercent || 0;
                const currentPrice = item.price * (1 - discountPercent / 100);
                const isOutOfStock = item.quantity > item.stock;

                return `
                <div class="cart-item" data-item-id="${item.id}" style="${isOutOfStock ? 'background-color: #fff5f5;' : ''}">
                    <img src="${(item.imageURLs && item.imageURLs.length > 0) ? item.imageURLs[0] : 'https://placehold.co/100x100'}" alt="${item.title}" class="item-img">
                    <div class="item-details">
                        <h3>${item.title}</h3>
                        <div class="item-price-details">
                            <span class="current-price">₹${Math.floor(currentPrice)}</span>
                            ${discountPercent > 0 ? `<span class="original-price">₹${Math.floor(item.price)}</span>` : ''}
                        </div>
                        ${isOutOfStock ? `<div class="stock-message"><i class="fas fa-exclamation-triangle"></i> Only ${item.stock} left in stock!</div>` : ''}
                    </div>
                    <div class="item-actions">
                         <div class="quantity-control">
                            <button data-action="decrease" onclick="updateQuantity(this, '${item.id}', ${item.quantity - 1})">-</button>
                            <input type="text" value="${item.quantity}" readonly>
                            <button data-action="increase" onclick="updateQuantity(this, '${item.id}', ${item.quantity + 1})">+</button>
                        </div>
                        <button class="remove-btn" onclick="confirmRemoveItem('${item.id}')"><i class="fas fa-trash"></i> Remove</button>
                    </div>
                </div>`;
            }).join('');
            calculateSummary();
        }

        function calculateSummary() {
            const deliveryFee = 19;
            const subtotal = cartItemsData.reduce((total, item) => total + (item.price * (1 - (item.discountPercent || 0) / 100) * item.quantity), 0);
            const total = subtotal + deliveryFee;
            document.getElementById('subtotal-price').textContent = `₹${Math.floor(subtotal)}`;
            document.getElementById('total-price').textContent = `₹${Math.floor(total)}`;

            // STOCK CHECK FOR CHECKOUT BUTTON
            const hasStockIssue = cartItemsData.some(item => item.quantity > item.stock);
            checkoutBtn.disabled = hasStockIssue;
            if(hasStockIssue) checkoutBtn.title = "Please resolve stock issues before proceeding.";
            else checkoutBtn.title = "";
        }

        // --- CART ACTIONS ---
        window.updateQuantity = async (element, itemId, newQuantity) => {
            const controlDiv = element.closest('.quantity-control');
            controlDiv.querySelectorAll('button').forEach(btn => btn.disabled = true);

            if (newQuantity < 1) { 
                controlDiv.querySelectorAll('button').forEach(btn => btn.disabled = false);
                confirmRemoveItem(itemId); 
                return; 
            }

            const itemInCart = cartItemsData.find(item => item.id === itemId);
            if(newQuantity > itemInCart.stock && element.dataset.action === 'increase') {
                showToast(`Max stock for ${itemInCart.title} is ${itemInCart.stock}!`, 'error');
                controlDiv.querySelectorAll('button').forEach(btn => btn.disabled = false);
                return;
            }

            itemInCart.quantity = newQuantity;
            renderCart();

            const uid = auth.currentUser.uid;
            await db.collection('users').doc(uid).collection('cart').doc(itemId).update({ quantity: newQuantity });
            controlDiv.querySelectorAll('button').forEach(btn => btn.disabled = false);
        };

        window.confirmRemoveItem = (itemId) => {
            showModal(
                'Remove Item?', 
                'Are you sure you want to remove this item from your cart?',
                () => removeItem(itemId)
            );
        };
        
        async function removeItem(itemId) {
            const uid = auth.currentUser.uid;
            await db.collection('users').doc(uid).collection('cart').doc(itemId).delete();
            cartItemsData = cartItemsData.filter(item => item.id !== itemId);
            
            showToast('Item removed from cart', 'success');

            if (cartItemsData.length > 0) renderCart();
            else showEmptyCart();
        }

        clearCartBtn.addEventListener('click', () => {
             showModal(
                'Clear Cart?', 
                'Are you sure you want to remove all items from your cart?',
                async () => {
                    const uid = auth.currentUser.uid;
                    const cartRef = db.collection('users').doc(uid).collection('cart');
                    const snapshot = await cartRef.get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();

                    cartItemsData = [];
                    showToast('Cart has been cleared', 'success');
                    showEmptyCart();
                }
            );
        });

        checkoutBtn.addEventListener('click', () => {
            if (cartItemsData.length > 0) {
                localStorage.setItem('cartItems', JSON.stringify(cartItemsData));
                window.location.href = 'checkout.html';
            } else {
                showToast("Your cart is empty!", 'error');
            }
        });

        // --- UTILITY FUNCTIONS (TOAST & MODAL) ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }

        function showModal(title, message, onConfirm) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            const newConfirmBtn = confirmBtn.cloneNode(true); // Remove old listeners
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                modal.classList.remove('visible');
            });
            
            cancelBtn.onclick = () => modal.classList.remove('visible');
            
            modal.classList.add('visible');
        }

    </script>
</body>
</html>